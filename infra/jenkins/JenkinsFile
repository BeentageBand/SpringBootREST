pipeline {
  agent {label 'Jenkins'}
  options {
    // This is required if you want to clean before build
    skipDefaultCheckout(true)
  }
  stages {
    stage ('Compile') {
      steps {
        cleanWs()
        git(branch: 'main', 
            url: 'https://github.com/BeentageBand/SpringBootREST')
        sh 'mvn compile'
      }
    }
    stage ('Test') {
      steps {
        sh 'mvn package'
      }
    }
    stage ('Deploy') {
      steps {
        git(branch: 'infra-ansible', 
            url: 'https://github.com/BeentageBand/SpringBootREST')
        sh 'mv target/ infra/ansible/'
        sh 'ansible-playbook --private-key /home/ubuntu/.ssh/jenkins.pem -i /home/ubuntu/hosts infra/ansible/tomcat.yml'
        sh 'ansible-playbook --private-key /home/ubuntu/.ssh/jenkins.pem -i /home/ubuntu/hosts infra/ansible/deploy.yml'
      }
    }
  }
  post {
    // Clean after Build
    always {
      cleanWs(cleanWhenNotBuilt: false,
          deleteDirs:true,
          disableDeferredWipeout: true,
          notFailBuild:true)
    }
  }
}
