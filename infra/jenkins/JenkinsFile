pipeline {
  agent any
  options {
    // This is required if you want to clean before build
    skipDefaultCheckout(true)
  }
  stages {
    stage ("Compile") {
      steps {
        cleanWs()
        git(branch: 'main', 
            url: 'https://github.com/BeentageBand/SpringBootREST')
        sh "mvn compile"
      }
    }
    stage ("Test") {
      steps {
        sh "mvn test"
      }
    }
    stage ("Deploy") {
      steps {
        git(branch: 'infra-ansible', 
            url: 'https://github.com/BeentageBand/SpringBootREST')
        ansiblePlaybook(become: true,
            becomeUser: 'ubuntu',
            inventory: '/home/ubuntu/hosts',
            limit: 'jenkins',
            playbook: 'infra/ansible/deploy.yml')
      }
    }
  }
  post {
    // Clean after Build
    always {
      cleanWs(cleanWhenNotBuilt: false,
          deleteDirs:true,
          disableDeferredWipeout: true,
          notFailBuild:true)
    }
  }
}
